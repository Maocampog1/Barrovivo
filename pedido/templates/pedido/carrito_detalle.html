{% extends "base.html" %}
{% load humanize %}

{% block content %}
<div class="carrito-container">
  <div class="row g-4">
    <!-- Panel izquierdo: Lista de productos -->
    <div class="col-lg-8">
      <div class="carrito-panel">
        <h1 class="carrito-titulo">Carro de Compras</h1>
        
        {% if items %}
          <!-- Total general -->
          <div class="carrito-total-general">
            <span class="total-label">Total:</span>
            <span class="total-valor">${{ total|intcomma }}</span>
          </div>
          
          <!-- Lista de productos -->
          <div class="productos-lista">
            {% for item in items %}
            <div class="producto-item">
              <div class="producto-imagen">
                {% if item.producto.imagen %}
                  <img src="{{ item.producto.imagen.url }}" alt="{{ item.producto.nombre }}" class="img-fluid">
                {% else %}
                  <div class="imagen-placeholder">
                    <i class="bi bi-image"></i>
                  </div>
                {% endif %}
              </div>
              
              <div class="producto-info">
                <h5 class="producto-nombre">{{ item.producto.nombre }}</h5>
                <p class="producto-precio">${{ item.producto.precio|intcomma }}</p>
              </div>
              
              <div class="producto-controles">
                <div class="cantidad-control">
                  <button type="button" class="btn-cantidad" onclick="cambiarCantidad({{ item.id }}, -1)">−</button>
                  <span class="cantidad-valor" id="cantidad-{{ item.id }}">{{ item.cantidad }}</span>
                  <button type="button" class="btn-cantidad" onclick="cambiarCantidad({{ item.id }}, 1)">+</button>
                </div>
                
                <button type="button" class="btn-remover" onclick="removerProducto({{ item.id }})" title="Remover producto">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
            {% endfor %}
          </div>
        {% else %}
          <!-- Carrito vacío -->
          <div class="carrito-vacio">
            <i class="bi bi-cart3"></i>
            <h3>Tu carrito está vacío</h3>
            <p>Agrega algunos productos para comenzar a comprar.</p>
            <a href="{% url 'producto:productos' %}" class="btn btn-bv">
              Ver productos
            </a>
          </div>
        {% endif %}
      </div>
    </div>
    
    <!-- Panel derecho: Totales y checkout -->
    {% if items %}
    <div class="col-lg-4">
      <div class="totales-panel">
        <h2 class="totales-titulo">Totales del carrito</h2>
        
        <div class="totales-detalle">
          <div class="total-linea">
            <span class="total-label">Subtotal:</span>
            <span class="total-valor">${{ total|intcomma }}</span>
          </div>
          
          <div class="total-linea total-final">
            <span class="total-label">Total:</span>
            <span class="total-valor">${{ total|intcomma }}</span>
          </div>
        </div>
        
        <button class="btn-checkout" disabled>
          Ir a pagar
        </button>
        
        <small class="checkout-nota">
          El checkout estará disponible próximamente
        </small>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Formularios ocultos para las acciones -->
<form id="form-actualizar" method="post" style="display: none;">
  {% csrf_token %}
  <input type="hidden" name="cantidad" id="cantidad-input">
</form>

<form id="form-remover" method="post" style="display: none;">
  {% csrf_token %}
</form>

<script>
function cambiarCantidad(itemId, cambio) {
  const valorElement = document.getElementById('cantidad-' + itemId);
  const nuevaCantidad = parseInt(valorElement.textContent) + cambio;
  
  if (nuevaCantidad >= 1) {
    valorElement.textContent = nuevaCantidad;
    
    // Enviar formulario para actualizar
    const form = document.getElementById('form-actualizar');
    const input = document.getElementById('cantidad-input');
    input.value = nuevaCantidad;
    form.action = "{% url 'pedido:actualizar_cantidad' 0 %}".replace('0', itemId);
    form.submit();
  }
}

function removerProducto(itemId) {
  if (confirm('¿Estás seguro de que quieres remover este producto?')) {
    const form = document.getElementById('form-remover');
    form.action = "{% url 'pedido:remover_del_carrito' 0 %}".replace('0', itemId);
    form.submit();
  }
}
</script>
{% endblock %}
