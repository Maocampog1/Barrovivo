{% extends "base.html" %}
{% load humanize i18n %}

{% block content %}
<div class="container-xl detalle-producto py-4">
  <div class="row g-4 align-items-start">

    <!-- Imagen -->
    <div class="col-12 col-lg-6">
      <div class="p-3 bg-white border rounded-3 text-center position-relative">
        <!-- Botón de favoritos -->
        <div class="favorito-btn position-absolute" style="top: 15px; right: 15px; z-index: 10;">
          {% if user.is_authenticated %}
            <form method="post" action="{% url 'producto:toggle_favorito' producto.id %}" class="d-inline">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.path }}?q={{ cantidad }}">
              <button type="submit"
                      class="btn-favorito btn-favorito-lg {% if es_favorito %}favorito-activo{% endif %}"
                      title="{% if es_favorito %}{% trans 'Quitar de favoritos' %}{% else %}{% trans 'Agregar a favoritos' %}{% endif %}">
                <i class="bi bi-heart{% if es_favorito %}-fill{% endif %}"></i>
              </button>
            </form>
          {% else %}
            <a href="{% url 'usuario:login' %}?next={{ request.path }}?q={{ cantidad }}"
               class="btn-favorito btn-favorito-lg"
               title="{% trans 'Inicia sesión para agregar a favoritos' %}">
              <i class="bi bi-heart"></i>
            </a>
          {% endif %}
        </div>

        {% if producto.imagen %}
          <img src="{{ producto.imagen.url }}" class="img-fluid"
               style="max-height:520px;object-fit:contain;" alt="{{ producto.nombre }}">
        {% else %}
          <div class="py-5 text-muted">{% trans "Sin imagen" %}</div>
        {% endif %}
      </div>
    </div>

    <!-- Datos -->
    <div class="col-12 col-lg-6">
      <h1 class="h2 fw-bold mb-3">{{ producto.nombre }}</h1>
      <p class="fs-5 mb-4">
        {% trans "Precio" %}: ${{ producto.precio|floatformat:0|intcomma }}
      </p>

      <!-- Cantidad + botón -->
      <div class="d-flex align-items-center gap-2 mb-2">
        <div class="btn-group cantidad" role="group" aria-label="{% trans 'Cantidad' %}">
          <a class="btn btn-outline-secondary btn-sm {% if cantidad <= 1 or sin_stock %}disabled{% endif %}"
             href="?q={{ cantidad|add:'-1' }}" aria-label="{% trans 'Disminuir' %}">−</a>

          <input type="text" class="form-control form-control-sm text-center cantidad-input"
                 value="{{ cantidad }}" readonly style="width:56px;">

          {% if al_tope or sin_stock %}
            <a class="btn btn-outline-secondary btn-sm disabled" aria-disabled="true">+</a>
          {% else %}
            <a class="btn btn-outline-secondary btn-sm"
               href="?q={{ cantidad|add:'1' }}" aria-label="{% trans 'Aumentar' %}">+</a>
          {% endif %}
        </div>

        <form method="post" action="{% url 'pedido:agregar_al_carrito' producto.id %}" class="d-inline">
          {% csrf_token %}
          <input type="hidden" name="cantidad" value="{{ cantidad }}">
          <input type="hidden" name="next" value="{{ request.path }}?q={{ cantidad }}">
          <button type="submit" class="btn btn-bv btn-lg rounded-pill px-4" {% if sin_stock %}disabled{% endif %}>
            {% trans "Añadir al carrito" %}
          </button>
        </form>
      </div>

      {% if sin_stock %}
        <div class="text-danger small">{% trans "Producto agotado." %}</div>
      {% elif excedido %}
        <div class="text-danger small">
          {% blocktrans with max=stock %}No hay esa cantidad disponible. Máximo {{ max }}.{% endblocktrans %}
        </div>
      {% elif al_tope %}
        <div class="text-danger small">{% trans "Ya no puedes seleccionar más." %}</div>
      {% else %}
        <div class="text-muted small">
          {% blocktrans with s=stock %}Disponible: {{ s }}{% endblocktrans %}
        </div>
      {% endif %}

      {% if producto.descripcion %}
        <div class="mb-4 mt-3">
          <div class="fw-semibold">{% trans "Descripción:" %}</div>
          <div>{{ producto.descripcion }}</div>
        </div>
      {% endif %}

      <!-- Categorías -->
      <div>
        <div class="fw-semibold">{% trans "Categorías:" %}</div>
        {% with cats=producto.categorias.all %}
          {% if cats %}
            <ul class="mb-0">
              {% for c in cats %}
                <li>{{ c.nombre }}</li>
              {% endfor %}
            </ul>
          {% else %}
            <ul class="mb-0">
              <li class="text-muted">{% trans "Sin categoría" %}</li>
            </ul>
          {% endif %}
        {% endwith %}
      </div>

    </div>
  </div>
</div>
{% endblock %}
